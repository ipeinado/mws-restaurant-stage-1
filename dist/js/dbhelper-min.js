class DBHelper{static get DATABASE_URL(){return"http://localhost:1337/restaurants"}static openDB(){if("indexedDB"in window)return idb.open("mws",1,e=>{switch(e.oldVersion){case 0:let t=e.createObjectStore("restaurants",{keyPath:"id"});t.createIndex("cuisine_type","cuisine_type",{unique:!1}),t.createIndex("neighborhood","neighborhood",{unique:!1});case 1:e.createObjectStore("reviews",{keyPath:"id",autoIncrement:!0})}});console.log("This browser doesn't support IndexedDB")}static fetchRestaurants(e){const t=DBHelper.openDB(),r=DBHelper.DATABASE_URL;fetch(r).then(e=>e.json()).then(t=>{e(null,t),DBHelper.saveRestaurantsLocally(t).catch(e=>console.warn(e))}).catch(r=>{console.log(`Request failed. Error returned: ${r}`),t.then(e=>{return console.log("calling database"),e.transaction("restaurants","readonly").objectStore("restaurants").getAll()}).then(t=>e(null,t)).catch(t=>e(t,null))})}static fetchRestaurantById(e,t){DBHelper.fetchRestaurants((r,n)=>{if(r)t(r,null);else{const r=n.find(t=>t.id==e);r?t(null,r):t("Restaurant does not exist",null)}})}static fetchRestaurantByCuisine(e,t){DBHelper.fetchRestaurants((r,n)=>{if(r)t(r,null);else{const r=n.filter(t=>t.cuisine_type==e);t(null,r)}})}static fetchRestaurantByNeighborhood(e,t){DBHelper.fetchRestaurants((r,n)=>{if(r)t(r,null);else{const r=n.filter(t=>t.neighborhood==e);t(null,r)}})}static fetchRestaurantByCuisineAndNeighborhood(e,t,r){DBHelper.fetchRestaurants((n,s)=>{if(n)r(n,null);else{let n=s;"all"!=e&&(n=n.filter(t=>t.cuisine_type==e)),"all"!=t&&(n=n.filter(e=>e.neighborhood==t)),r(null,n)}})}static fetchNeighborhoods(e){DBHelper.fetchRestaurants((t,r)=>{if(t)e(t,null);else{const t=r.map((e,t)=>r[t].neighborhood),n=t.filter((e,r)=>t.indexOf(e)==r);e(null,n)}})}static fetchCuisines(e){DBHelper.fetchRestaurants((t,r)=>{if(t)e(t,null);else{const t=r.map((e,t)=>r[t].cuisine_type),n=t.filter((e,r)=>t.indexOf(e)==r);e(null,n)}})}static saveRestaurantsLocally(e){if(!("indexedDB"in window))return null;return DBHelper.openDB().then(t=>{const r=t.transaction("restaurants","readwrite").objectStore("restaurants");return Promise.all(e.map(e=>r.put(e))).catch(e=>{throw Error("could not store restaurants in database")})})}static fetchReviews(e){DBHelper.getServerReviews().then(t=>{console.log("Getting reviews from network"),e(null,t),DBHelper.saveReviewsLocally(t).then(()=>console.log("Data from network saved in local store")).catch(e=>console.warn(e))}).catch(t=>{console.log("Network requests have failed, this is expected if offline"),DBHelper.getLocalReviews().then(t=>{t.length?e(null,t):console.log("No data")})})}static fetchReviewsByRestaurant(e,t){DBHelper.fetchReviews((r,n)=>{if(r)t(r,null);else{const r=n.filter(t=>t.restaurant_id==e);t(null,r)}})}static getServerReviews(){return fetch("http://localhost:1337/reviews").then(e=>{if(!e.ok)throw Error(e.statusText);return e.json()})}static saveReviewsLocally(e){if(!("indexedDB"in window))return null;return DBHelper.openDB().then(t=>{const r=t.transaction("reviews","readwrite").objectStore("reviews");return Promise.all(e.map(e=>r.put(e))).catch(e=>{throw Error("Reviews were not added to the store: "+e)})})}static getLocalReviews(){return"indexedDB"in window?DBHelper.openDB().then(e=>{return e.transaction("reviews","readonly").objectStore("reviews").getAll()}):null}static urlForRestaurant(e){return`./restaurant.html?id=${e.id}`}static imageUrlForRestaurant(e){return`/img/${e.photograph}`}static urlForReviews(e){return`./reviews/?restaurant_id=${e.id}`}static mapMarkerForRestaurant(e,t){return new google.maps.Marker({position:e.latlng,title:e.name,url:DBHelper.urlForRestaurant(e),map:t,animation:google.maps.Animation.DROP})}}
//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRiaGVscGVyLmpzIl0sIm5hbWVzIjpbIkRCSGVscGVyIiwiREFUQUJBU0VfVVJMIiwiW29iamVjdCBPYmplY3RdIiwid2luZG93IiwiaWRiIiwib3BlbiIsInVwZ3JhZGVEQiIsIm9sZFZlcnNpb24iLCJyZXN0YXVyYW50c1N0b3JlIiwiY3JlYXRlT2JqZWN0U3RvcmUiLCJrZXlQYXRoIiwiY3JlYXRlSW5kZXgiLCJ1bmlxdWUiLCJhdXRvSW5jcmVtZW50IiwiY29uc29sZSIsImxvZyIsImNhbGxiYWNrIiwiZGJQcm9taXNlIiwib3BlbkRCIiwidXJsIiwiZmV0Y2giLCJ0aGVuIiwicmVzcG9uc2UiLCJqc29uIiwicmVzdGF1cmFudHNKc29uIiwic2F2ZVJlc3RhdXJhbnRzTG9jYWxseSIsImNhdGNoIiwiZXJyIiwid2FybiIsImRiIiwidHJhbnNhY3Rpb24iLCJvYmplY3RTdG9yZSIsImdldEFsbCIsInJlc3RhdXJhbnRzIiwiaWQiLCJmZXRjaFJlc3RhdXJhbnRzIiwiZXJyb3IiLCJyZXN0YXVyYW50IiwiZmluZCIsInIiLCJjdWlzaW5lIiwicmVzdWx0cyIsImZpbHRlciIsImN1aXNpbmVfdHlwZSIsIm5laWdoYm9yaG9vZCIsIm5laWdoYm9yaG9vZHMiLCJtYXAiLCJ2IiwiaSIsInVuaXF1ZU5laWdoYm9yaG9vZHMiLCJpbmRleE9mIiwiY3Vpc2luZXMiLCJ1bmlxdWVDdWlzaW5lcyIsInN0b3JlIiwiUHJvbWlzZSIsImFsbCIsInB1dCIsIkVycm9yIiwiZ2V0U2VydmVyUmV2aWV3cyIsInJldmlld3NGcm9tTmV0d29yayIsInNhdmVSZXZpZXdzTG9jYWxseSIsImdldExvY2FsUmV2aWV3cyIsIm9mZmxpbmVEYXRhIiwibGVuZ3RoIiwicmVzdGF1cmFudF9pZCIsImZldGNoUmV2aWV3cyIsInJldmlld3MiLCJvayIsInN0YXR1c1RleHQiLCJyZXZpZXciLCJwaG90b2dyYXBoIiwiZ29vZ2xlIiwibWFwcyIsIk1hcmtlciIsInBvc2l0aW9uIiwibGF0bG5nIiwidGl0bGUiLCJuYW1lIiwidXJsRm9yUmVzdGF1cmFudCIsImFuaW1hdGlvbiIsIkFuaW1hdGlvbiIsIkRST1AiXSwibWFwcGluZ3MiOiJBQUdBLE1BQU1BLFNBS0pDLDBCQUVFLE1BQU8sb0NBR1RDLGdCQUNFLEdBQU0sY0FBZUMsT0FLckIsT0FBT0MsSUFBSUMsS0FBSyxNQUFPLEVBQUlDLElBQ3pCLE9BQU9BLEVBQVVDLFlBQ2YsS0FBSyxFQUNILElBQUlDLEVBQW1CRixFQUFVRyxrQkFBa0IsY0FBZSxDQUFDQyxRQUFTLE9BQzVFRixFQUFpQkcsWUFBWSxlQUFnQixlQUFnQixDQUFDQyxRQUFRLElBQ3RFSixFQUFpQkcsWUFBWSxlQUFnQixlQUFnQixDQUFDQyxRQUFRLElBQ3hFLEtBQUssRUFDZ0JOLEVBQVVHLGtCQUFrQixVQUFXLENBQUNDLFFBQVMsS0FBTUcsZUFBZSxPQVg3RkMsUUFBUUMsSUFBSSwwQ0FnQmhCYix3QkFBd0JjLEdBRXRCLE1BQU1DLEVBQVlqQixTQUFTa0IsU0FFckJDLEVBQU1uQixTQUFTQyxhQUVyQm1CLE1BQU1ELEdBQ0hFLEtBQUtDLEdBQVlBLEVBQVNDLFFBQzFCRixLQUFLRyxJQUNKUixFQUFTLEtBQU1RLEdBQ2Z4QixTQUFTeUIsdUJBQXVCRCxHQUM3QkUsTUFBT0MsR0FBUWIsUUFBUWMsS0FBS0QsTUFFaENELE1BQU1DLElBQ0xiLFFBQVFDLHVDQUF1Q1ksS0FDL0NWLEVBQ0dJLEtBQU1RLElBSUwsT0FIQWYsUUFBUUMsSUFBSSxvQkFDRGMsRUFBR0MsWUFBWSxjQUFlLFlBQ3hCQyxZQUFZLGVBQ2hCQyxXQUVkWCxLQUFLWSxHQUFlakIsRUFBUyxLQUFNaUIsSUFDbkNQLE1BQU1DLEdBQU9YLEVBQVNXLEVBQUssU0FPcEN6QiwyQkFBMkJnQyxFQUFJbEIsR0FFN0JoQixTQUFTbUMsaUJBQWlCLENBQUNDLEVBQU9ILEtBQ2hDLEdBQUlHLEVBQ0ZwQixFQUFTb0IsRUFBTyxVQUNYLENBQ0wsTUFBTUMsRUFBYUosRUFBWUssS0FBS0MsR0FBS0EsRUFBRUws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QyxFQUFTOEMsWUFFdkIsT0FBTzlDLEVBQVNDLFNBT3ZCckIsMEJBQTBCZ0UsR0FDekIsS0FBTSxjQUFlL0QsUUFBVSxPQUFPLEtBR3RDLE9BRmtCSCxTQUFTa0IsU0FFVkcsS0FBS1EsSUFDcEIsTUFDTXdCLEVBREt4QixFQUFHQyxZQUFZLFVBQVcsYUFDcEJDLFlBQVksV0FDN0IsT0FBT3VCLFFBQVFDLElBQUlXLEVBQVFwQixJQUFJdUIsR0FBVWhCLEVBQU1HLElBQUlhLEtBQ2hEM0MsTUFBT0MsSUFDTixNQUFNOEIsTUFBTSx3Q0FBMEM5QixPQVE3RHpCLHlCQUNDLE1BQU0sY0FBZUMsT0FDZEgsU0FBU2tCLFNBQVNHLEtBQUtRLElBRzVCLE9BRldBLEVBQUdDLFlBQVksVUFBVyxZQUNwQkMsWUFBWSxXQUNoQkMsV0FKdUIsS0FXeEM5Qix3QkFBd0JtQyxHQUN0Qiw4QkFBZ0NBLEVBQVdILEtBTTdDaEMsNkJBQTZCbUMsR0FDM0IsY0FBZ0JBLEVBQVdpQyxhQU01QnBFLHFCQUFxQm1DLEdBQ3BCLGtDQUFvQ0EsRUFBV0gsS0FNakRoQyw4QkFBOEJtQyxFQUFZUyxHQVF4QyxPQVBlLElBQUl5QixPQUFPQyxLQUFLQyxPQUFPLENBQ3BDQyxTQUFVckMsRUFBV3NDLE9BQ3JCQyxNQUFPdkMsRUFBV3dDLEtBQ2xCMUQsSUFBS25CLFNBQVM4RSxpQkFBaUJ6QyxHQUMvQlMsSUFBS0EsRUFDTGlDLFVBQVdSLE9BQU9DLEtBQUtRLFVBQVVDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXHJcbiAqIENvbW1vbiBkYXRhYmFzZSBoZWxwZXIgZnVuY3Rpb25zLlxyXG4gKi9cclxuY2xhc3MgREJIZWxwZXIge1xyXG4gIC8qKlxyXG4gICAqIERhdGFiYXNlIFVSTC5cclxuICAgKiBDaGFuZ2UgdGhpcyB0byByZXN0YXVyYW50cy5qc29uIGZpbGUgbG9jYXRpb24gb24geW91ciBzZXJ2ZXIuXHJcbiAgICovXHJcbiAgc3RhdGljIGdldCBEQVRBQkFTRV9VUkwoKSB7XHJcbiAgICBjb25zdCBwb3J0ID0gMTMzNyAvLyBDaGFuZ2UgdGhpcyB0byB5b3VyIHNlcnZlciBwb3J0XHJcbiAgICByZXR1cm4gYGh0dHA6Ly9sb2NhbGhvc3Q6JHtwb3J0fS9yZXN0YXVyYW50c2A7XHJcbiAgfVxyXG5cclxuICBzdGF0aWMgb3BlbkRCKCkge1xyXG4gICAgaWYgKCEoJ2luZGV4ZWREQicgaW4gd2luZG93KSkge1xyXG4gICAgICBjb25zb2xlLmxvZygnVGhpcyBicm93c2VyIGRvZXNuXFwndCBzdXBwb3J0IEluZGV4ZWREQicpO1xyXG4gICAgICByZXR1cm47XHJcbiAgICB9XHJcblxyXG4gICAgcmV0dXJuIGlkYi5vcGVuKCdtd3MnLCAxLCAodXBncmFkZURCKSA9PiB7XHJcbiAgICAgIHN3aXRjaCh1cGdyYWRlREIub2xkVmVyc2lvbikge1xyXG4gICAgICAgIGNhc2UgMDpcclxuICAgICAgICAgIGxldCByZXN0YXVyYW50c1N0b3JlID0gdXBncmFkZURCLmNyZWF0ZU9iamVjdFN0b3JlKCdyZXN0YXVyYW50cycsIHtrZXlQYXRoOiAnaWQnfSk7XHJcbiAgICAgICAgICByZXN0YXVyYW50c1N0b3JlLmNyZWF0ZUluZGV4KCdjdWlzaW5lX3R5cGUnLCAnY3Vpc2luZV90eXBlJywge3VuaXF1ZTogZmFsc2V9KTtcclxuICAgICAgICAgIHJlc3RhdXJhbnRzU3RvcmUuY3JlYXRlSW5kZXgoJ25laWdoYm9yaG9vZCcsICduZWlnaGJvcmhvb2QnLCB7dW5pcXVlOiBmYWxzZX0pO1xyXG4gICAgICAgIGNhc2UgMTpcclxuICAgICAgICAgIGxldCByZXZpZXdzU3RvcmUgPSB1cGdyYWRlREIuY3JlYXRlT2JqZWN0U3RvcmUoJ3Jldmlld3MnLCB7a2V5UGF0aDogJ2lkJywgYXV0b0luY3JlbWVudDogdHJ1ZX0pO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRzKGNhbGxiYWNrKSB7XHJcblxyXG4gICAgY29uc3QgZGJQcm9taXNlID0gREJIZWxwZXIub3BlbkRCKCk7XHJcblxyXG4gICAgY29uc3QgdXJsID0gREJIZWxwZXIuREFUQUJBU0VfVVJMO1xyXG5cclxuICAgIGZldGNoKHVybClcclxuICAgICAgLnRoZW4ocmVzcG9uc2UgPT4gcmVzcG9uc2UuanNvbigpKVxyXG4gICAgICAudGhlbihyZXN0YXVyYW50c0pzb24gPT4ge1xyXG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHJlc3RhdXJhbnRzSnNvbik7XHJcbiAgICAgICAgREJIZWxwZXIuc2F2ZVJlc3RhdXJhbnRzTG9jYWxseShyZXN0YXVyYW50c0pzb24pXHJcbiAgICAgICAgICAuY2F0Y2goKGVycikgPT4gY29uc29sZS53YXJuKGVycikpO1xyXG4gICAgICB9KVxyXG4gICAgICAuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZyhgUmVxdWVzdCBmYWlsZWQuIEVycm9yIHJldHVybmVkOiAke2Vycn1gKTtcclxuICAgICAgICBkYlByb21pc2VcclxuICAgICAgICAgIC50aGVuKChkYikgPT4ge1xyXG4gICAgICAgICAgICBjb25zb2xlLmxvZygnY2FsbGluZyBkYXRhYmFzZScpO1xyXG4gICAgICAgICAgICBjb25zdCB0eCA9IGRiLnRyYW5zYWN0aW9uKCdyZXN0YXVyYW50cycsICdyZWFkb25seScpO1xyXG4gICAgICAgICAgICBjb25zdCBzdG9yZSA9IHR4Lm9iamVjdFN0b3JlKCdyZXN0YXVyYW50cycpO1xyXG4gICAgICAgICAgICByZXR1cm4gc3RvcmUuZ2V0QWxsKCk7XHJcbiAgICAgICAgICB9KVxyXG4gICAgICAgICAgLnRoZW4ocmVzdGF1cmFudHMgPT4gY2FsbGJhY2sobnVsbCwgcmVzdGF1cmFudHMpKVxyXG4gICAgICAgICAgLmNhdGNoKGVyciA9PiBjYWxsYmFjayhlcnIsIG51bGwpKTtcclxuICAgICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCBhIHJlc3RhdXJhbnQgYnkgaXRzIElELlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRCeUlkKGlkLCBjYWxsYmFjaykge1xyXG4gICAgLy8gZmV0Y2ggYWxsIHJlc3RhdXJhbnRzIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxyXG4gICAgREJIZWxwZXIuZmV0Y2hSZXN0YXVyYW50cygoZXJyb3IsIHJlc3RhdXJhbnRzKSA9PiB7XHJcbiAgICAgIGlmIChlcnJvcikge1xyXG4gICAgICAgIGNhbGxiYWNrKGVycm9yLCBudWxsKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICBjb25zdCByZXN0YXVyYW50ID0gcmVzdGF1cmFudHMuZmluZChyID0+IHIuaWQgPT0gaWQpO1xyXG4gICAgICAgIGlmIChyZXN0YXVyYW50KSB7IC8vIEdvdCB0aGUgcmVzdGF1cmFudFxyXG4gICAgICAgICAgY2FsbGJhY2sobnVsbCwgcmVzdGF1cmFudCk7XHJcbiAgICAgICAgfSBlbHNlIHsgLy8gUmVzdGF1cmFudCBkb2VzIG5vdCBleGlzdCBpbiB0aGUgZGF0YWJhc2VcclxuICAgICAgICAgIGNhbGxiYWNrKCdSZXN0YXVyYW50IGRvZXMgbm90IGV4aXN0JywgbnVsbCk7XHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIHJlc3RhdXJhbnRzIGJ5IGEgY3Vpc2luZSB0eXBlIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaFJlc3RhdXJhbnRCeUN1aXNpbmUoY3Vpc2luZSwgY2FsbGJhY2spIHtcclxuICAgIC8vIEZldGNoIGFsbCByZXN0YXVyYW50cyAgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmdcclxuICAgIERCSGVscGVyLmZldGNoUmVzdGF1cmFudHMoKGVycm9yLCByZXN0YXVyYW50cykgPT4ge1xyXG4gICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gRmlsdGVyIHJlc3RhdXJhbnRzIHRvIGhhdmUgb25seSBnaXZlbiBjdWlzaW5lIHR5cGVcclxuICAgICAgICBjb25zdCByZXN1bHRzID0gcmVzdGF1cmFudHMuZmlsdGVyKHIgPT4gci5jdWlzaW5lX3R5cGUgPT0gY3Vpc2luZSk7XHJcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgcmVzdWx0cyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmV0Y2ggcmVzdGF1cmFudHMgYnkgYSBuZWlnaGJvcmhvb2Qgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoUmVzdGF1cmFudEJ5TmVpZ2hib3Job29kKG5laWdoYm9yaG9vZCwgY2FsbGJhY2spIHtcclxuICAgIC8vIEZldGNoIGFsbCByZXN0YXVyYW50c1xyXG4gICAgREJIZWxwZXIuZmV0Y2hSZXN0YXVyYW50cygoZXJyb3IsIHJlc3RhdXJhbnRzKSA9PiB7XHJcbiAgICAgIGlmIChlcnJvcikge1xyXG4gICAgICAgIGNhbGxiYWNrKGVycm9yLCBudWxsKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyBGaWx0ZXIgcmVzdGF1cmFudHMgdG8gaGF2ZSBvbmx5IGdpdmVuIG5laWdoYm9yaG9vZFxyXG4gICAgICAgIGNvbnN0IHJlc3VsdHMgPSByZXN0YXVyYW50cy5maWx0ZXIociA9PiByLm5laWdoYm9yaG9vZCA9PSBuZWlnaGJvcmhvb2QpO1xyXG4gICAgICAgIGNhbGxiYWNrKG51bGwsIHJlc3VsdHMpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIHJlc3RhdXJhbnRzIGJ5IGEgY3Vpc2luZSBhbmQgYSBuZWlnaGJvcmhvb2Qgd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcuXHJcbiAgICovXHJcbiAgc3RhdGljIGZldGNoUmVzdGF1cmFudEJ5Q3Vpc2luZUFuZE5laWdoYm9yaG9vZChjdWlzaW5lLCBuZWlnaGJvcmhvb2QsIGNhbGxiYWNrKSB7XHJcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHNcclxuICAgIERCSGVscGVyLmZldGNoUmVzdGF1cmFudHMoKGVycm9yLCByZXN0YXVyYW50cykgPT4ge1xyXG4gICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgbGV0IHJlc3VsdHMgPSByZXN0YXVyYW50c1xyXG4gICAgICAgIGlmIChjdWlzaW5lICE9ICdhbGwnKSB7IC8vIGZpbHRlciBieSBjdWlzaW5lXHJcbiAgICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByLmN1aXNpbmVfdHlwZSA9PSBjdWlzaW5lKTtcclxuICAgICAgICB9XHJcbiAgICAgICAgaWYgKG5laWdoYm9yaG9vZCAhPSAnYWxsJykgeyAvLyBmaWx0ZXIgYnkgbmVpZ2hib3Job29kXHJcbiAgICAgICAgICByZXN1bHRzID0gcmVzdWx0cy5maWx0ZXIociA9PiByLm5laWdoYm9yaG9vZCA9PSBuZWlnaGJvcmhvb2QpO1xyXG4gICAgICAgIH1cclxuICAgICAgICBjYWxsYmFjayhudWxsLCByZXN1bHRzKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCBhbGwgbmVpZ2hib3Job29kcyB3aXRoIHByb3BlciBlcnJvciBoYW5kbGluZy5cclxuICAgKi9cclxuICBzdGF0aWMgZmV0Y2hOZWlnaGJvcmhvb2RzKGNhbGxiYWNrKSB7XHJcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHNcclxuICAgIERCSGVscGVyLmZldGNoUmVzdGF1cmFudHMoKGVycm9yLCByZXN0YXVyYW50cykgPT4ge1xyXG4gICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gR2V0IGFsbCBuZWlnaGJvcmhvb2RzIGZyb20gYWxsIHJlc3RhdXJhbnRzXHJcbiAgICAgICAgY29uc3QgbmVpZ2hib3Job29kcyA9IHJlc3RhdXJhbnRzLm1hcCgodiwgaSkgPT4gcmVzdGF1cmFudHNbaV0ubmVpZ2hib3Job29kKVxyXG4gICAgICAgIC8vIFJlbW92ZSBkdXBsaWNhdGVzIGZyb20gbmVpZ2hib3Job29kc1xyXG4gICAgICAgIGNvbnN0IHVuaXF1ZU5laWdoYm9yaG9vZHMgPSBuZWlnaGJvcmhvb2RzLmZpbHRlcigodiwgaSkgPT4gbmVpZ2hib3Job29kcy5pbmRleE9mKHYpID09IGkpXHJcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgdW5pcXVlTmVpZ2hib3Job29kcyk7XHJcbiAgICAgIH1cclxuICAgIH0pO1xyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogRmV0Y2ggYWxsIGN1aXNpbmVzIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBmZXRjaEN1aXNpbmVzKGNhbGxiYWNrKSB7XHJcbiAgICAvLyBGZXRjaCBhbGwgcmVzdGF1cmFudHNcclxuICAgIERCSGVscGVyLmZldGNoUmVzdGF1cmFudHMoKGVycm9yLCByZXN0YXVyYW50cykgPT4ge1xyXG4gICAgICBpZiAoZXJyb3IpIHtcclxuICAgICAgICBjYWxsYmFjayhlcnJvciwgbnVsbCk7XHJcbiAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgLy8gR2V0IGFsbCBjdWlzaW5lcyBmcm9tIGFsbCByZXN0YXVyYW50c1xyXG4gICAgICAgIGNvbnN0IGN1aXNpbmVzID0gcmVzdGF1cmFudHMubWFwKCh2LCBpKSA9PiByZXN0YXVyYW50c1tpXS5jdWlzaW5lX3R5cGUpXHJcbiAgICAgICAgLy8gUmVtb3ZlIGR1cGxpY2F0ZXMgZnJvbSBjdWlzaW5lc1xyXG4gICAgICAgIGNvbnN0IHVuaXF1ZUN1aXNpbmVzID0gY3Vpc2luZXMuZmlsdGVyKCh2LCBpKSA9PiBjdWlzaW5lcy5pbmRleE9mKHYpID09IGkpXHJcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgdW5pcXVlQ3Vpc2luZXMpO1xyXG4gICAgICB9XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqICBTdG9yZSByZXN0YXVyYW50cyBpbiBsb2NhbCBJREJcclxuICAgKi9cclxuICBzdGF0aWMgc2F2ZVJlc3RhdXJhbnRzTG9jYWxseShyZXN0YXVyYW50cykge1xyXG4gICAgaWYgKCEoJ2luZGV4ZWREQicgaW4gd2luZG93KSkge3JldHVybiBudWxsO31cclxuICAgIGNvbnN0IGRiUHJvbWlzZSA9IERCSGVscGVyLm9wZW5EQigpO1xyXG5cclxuICAgIHJldHVybiBkYlByb21pc2UudGhlbihkYiA9PiB7XHJcbiAgICAgIGNvbnN0IHR4ID0gZGIudHJhbnNhY3Rpb24oJ3Jlc3RhdXJhbnRzJywgJ3JlYWR3cml0ZScpO1xyXG4gICAgICBjb25zdCBzdG9yZSA9IHR4Lm9iamVjdFN0b3JlKCdyZXN0YXVyYW50cycpO1xyXG4gICAgICByZXR1cm4gUHJvbWlzZS5hbGwocmVzdGF1cmFudHMubWFwKHJlc3RhdXJhbnQgPT4gc3RvcmUucHV0KHJlc3RhdXJhbnQpKSlcclxuICAgICAgLmNhdGNoKGVyciA9PiB7XHJcbiAgICAgICAgdGhyb3cgRXJyb3IoXCJjb3VsZCBub3Qgc3RvcmUgcmVzdGF1cmFudHMgaW4gZGF0YWJhc2VcIik7XHJcbiAgICAgIH0pXHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIEZldGNoIGFsbCByZXZpZXdzIHdpdGggcHJvcGVyIGVycm9yIGhhbmRsaW5nXHJcbiAgICovXHJcbiAgIHN0YXRpYyBmZXRjaFJldmlld3MoY2FsbGJhY2spIHtcclxuXHJcbiAgICBEQkhlbHBlci5nZXRTZXJ2ZXJSZXZpZXdzKClcclxuICAgICAgLnRoZW4ocmV2aWV3c0Zyb21OZXR3b3JrID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZyhcIkdldHRpbmcgcmV2aWV3cyBmcm9tIG5ldHdvcmtcIik7XHJcbiAgICAgICAgY2FsbGJhY2sobnVsbCwgcmV2aWV3c0Zyb21OZXR3b3JrKTtcclxuICAgICAgICBEQkhlbHBlci5zYXZlUmV2aWV3c0xvY2FsbHkocmV2aWV3c0Zyb21OZXR3b3JrKVxyXG4gICAgICAgICAgLnRoZW4oKCkgPT4gY29uc29sZS5sb2coJ0RhdGEgZnJvbSBuZXR3b3JrIHNhdmVkIGluIGxvY2FsIHN0b3JlJykpXHJcbiAgICAgICAgICAuY2F0Y2goKGVycikgPT4gY29uc29sZS53YXJuKGVycikpO1xyXG4gICAgICB9KVxyXG4gICAgICAuY2F0Y2goZXJyID0+IHtcclxuICAgICAgICBjb25zb2xlLmxvZygnTmV0d29yayByZXF1ZXN0cyBoYXZlIGZhaWxlZCwgdGhpcyBpcyBleHBlY3RlZCBpZiBvZmZsaW5lJyk7XHJcbiAgICAgICAgREJIZWxwZXIuZ2V0TG9jYWxSZXZpZXdzKClcclxuICAgICAgICAgIC50aGVuKG9mZmxpbmVEYXRhID0+IHtcclxuICAgICAgICAgICAgaWYgKCFvZmZsaW5lRGF0YS5sZW5ndGgpIHtcclxuICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIk5vIGRhdGFcIik7XHJcbiAgICAgICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICAgICAgY2FsbGJhY2sobnVsbCwgb2ZmbGluZURhdGEpO1xyXG4gICAgICAgICAgICB9XHJcbiAgICAgICAgICB9KTtcclxuICAgICAgfSk7XHJcbiAgfVxyXG5cclxuICAvKipcclxuICAgKiBGZXRjaCByZXZpZXdzIGJ5IHJlc3RhdXJhbnRcclxuICAgKi9cclxuICAgc3RhdGljIGZldGNoUmV2aWV3c0J5UmVzdGF1cmFudChyZXN0YXVyYW50X2lkLCBjYWxsYmFjaykge1xyXG4gICAgLy8gRmV0Y2ggYWxsIHJlc3RhdXJhbnRzXHJcbiAgICBEQkhlbHBlci5mZXRjaFJldmlld3MoKGVycm9yLCByZXZpZXdzKSA9PiB7XHJcbiAgICAgIGlmIChlcnJvcikge1xyXG4gICAgICAgIGNhbGxiYWNrKGVycm9yLCBudWxsKTtcclxuICAgICAgfSBlbHNlIHtcclxuICAgICAgICAvLyBGaWx0ZXIgcmV2aWV3cyB3aXRoIGEgc3BlY2lmaWMgcmVzdGF1cmFudCBpZFxyXG4gICAgICAgIGNvbnN0IHJlc3VsdHMgPSByZXZpZXdzLmZpbHRlcihyID0+IHIucmVzdGF1cmFudF9pZCA9PSByZXN0YXVyYW50X2lkKTtcclxuICAgICAgICBjYWxsYmFjayhudWxsLCByZXN1bHRzKTtcclxuICAgICAgfVxyXG4gICAgfSk7XHJcbiAgIH1cclxuXHJcbiAgIC8qKlxyXG4gICAgKiBHZXQgcmV2aWV3cyBmcm9tIHNlcnZlclxyXG4gICAgKi9cclxuICAgIHN0YXRpYyBnZXRTZXJ2ZXJSZXZpZXdzKCkge1xyXG4gICAgICByZXR1cm4gZmV0Y2goJ2h0dHA6Ly9sb2NhbGhvc3Q6MTMzNy9yZXZpZXdzJylcclxuICAgICAgICAudGhlbihyZXNwb25zZSA9PiB7XHJcbiAgICAgICAgICBpZiAoIXJlc3BvbnNlLm9rKSB7XHJcbiAgICAgICAgICAgIHRocm93IEVycm9yKHJlc3BvbnNlLnN0YXR1c1RleHQpO1xyXG4gICAgICAgICAgfVxyXG4gICAgICAgICAgcmV0dXJuIHJlc3BvbnNlLmpzb24oKTtcclxuICAgICAgICB9KVxyXG4gICAgfVxyXG5cclxuICAgLyoqXHJcbiAgICogU2F2ZSByZXZpZXdzIGluIEluZGV4ZWREQlxyXG4gICAqL1xyXG4gICBzdGF0aWMgc2F2ZVJldmlld3NMb2NhbGx5KHJldmlld3MpIHtcclxuICAgIGlmICghKCdpbmRleGVkREInIGluIHdpbmRvdykpIHtyZXR1cm4gbnVsbDt9XHJcbiAgICBjb25zdCBkYlByb21pc2UgPSBEQkhlbHBlci5vcGVuREIoKTtcclxuXHJcbiAgICByZXR1cm4gZGJQcm9taXNlLnRoZW4oZGIgPT4ge1xyXG4gICAgICBjb25zdCB0eCA9IGRiLnRyYW5zYWN0aW9uKCdyZXZpZXdzJywgJ3JlYWR3cml0ZScpO1xyXG4gICAgICBjb25zdCBzdG9yZSA9IHR4Lm9iamVjdFN0b3JlKCdyZXZpZXdzJyk7XHJcbiAgICAgIHJldHVybiBQcm9taXNlLmFsbChyZXZpZXdzLm1hcChyZXZpZXcgPT4gc3RvcmUucHV0KHJldmlldykpKVxyXG4gICAgICAgIC5jYXRjaCgoZXJyKSA9PiB7XHJcbiAgICAgICAgICB0aHJvdyBFcnJvcignUmV2aWV3cyB3ZXJlIG5vdCBhZGRlZCB0byB0aGUgc3RvcmU6ICcgKyBlcnIpO1xyXG4gICAgICAgIH0pXHJcbiAgICB9KTtcclxuICAgfVxyXG5cclxuICAgLyoqXHJcbiAgICogIEdldCByZXZpZXdzIGZyb20gbG9jYWwgZGF0YWJhc2VcclxuICAgKi9cclxuICAgc3RhdGljIGdldExvY2FsUmV2aWV3cygpIHtcclxuICAgIGlmICghKCdpbmRleGVkREInIGluIHdpbmRvdykpIHtyZXR1cm4gbnVsbDt9XHJcbiAgICByZXR1cm4gREJIZWxwZXIub3BlbkRCKCkudGhlbihkYiA9PiB7XHJcbiAgICAgIGNvbnN0IHR4ID0gZGIudHJhbnNhY3Rpb24oJ3Jldmlld3MnLCAncmVhZG9ubHknKTtcclxuICAgICAgY29uc3Qgc3RvcmUgPSB0eC5vYmplY3RTdG9yZSgncmV2aWV3cycpO1xyXG4gICAgICByZXR1cm4gc3RvcmUuZ2V0QWxsKCk7XHJcbiAgICB9KTtcclxuICAgfVxyXG5cclxuICAvKipcclxuICAgKiBSZXN0YXVyYW50IHBhZ2UgVVJMLlxyXG4gICAqL1xyXG4gIHN0YXRpYyB1cmxGb3JSZXN0YXVyYW50KHJlc3RhdXJhbnQpIHtcclxuICAgIHJldHVybiAoYC4vcmVzdGF1cmFudC5odG1sP2lkPSR7cmVzdGF1cmFudC5pZH1gKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlc3RhdXJhbnQgaW1hZ2UgVVJMLlxyXG4gICAqL1xyXG4gIHN0YXRpYyBpbWFnZVVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCkge1xyXG4gICAgcmV0dXJuIChgL2ltZy8ke3Jlc3RhdXJhbnQucGhvdG9ncmFwaH1gKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFJlc3RhdXJhbnQgcmV2aWV3cyBVUkxcclxuICAgKi9cclxuICAgc3RhdGljIHVybEZvclJldmlld3MocmVzdGF1cmFudCkge1xyXG4gICAgcmV0dXJuIChgLi9yZXZpZXdzLz9yZXN0YXVyYW50X2lkPSR7cmVzdGF1cmFudC5pZH1gKTtcclxuICAgfVxyXG5cclxuICAvKipcclxuICAgKiBNYXAgbWFya2VyIGZvciBhIHJlc3RhdXJhbnQuXHJcbiAgICovXHJcbiAgc3RhdGljIG1hcE1hcmtlckZvclJlc3RhdXJhbnQocmVzdGF1cmFudCwgbWFwKSB7XHJcbiAgICBjb25zdCBtYXJrZXIgPSBuZXcgZ29vZ2xlLm1hcHMuTWFya2VyKHtcclxuICAgICAgcG9zaXRpb246IHJlc3RhdXJhbnQubGF0bG5nLFxyXG4gICAgICB0aXRsZTogcmVzdGF1cmFudC5uYW1lLFxyXG4gICAgICB1cmw6IERCSGVscGVyLnVybEZvclJlc3RhdXJhbnQocmVzdGF1cmFudCksXHJcbiAgICAgIG1hcDogbWFwLFxyXG4gICAgICBhbmltYXRpb246IGdvb2dsZS5tYXBzLkFuaW1hdGlvbi5EUk9QfVxyXG4gICAgKTtcclxuICAgIHJldHVybiBtYXJrZXI7XHJcbiAgfVxyXG5cclxufVxyXG4iXSwiZmlsZSI6ImRiaGVscGVyLW1pbi5qcyJ9
